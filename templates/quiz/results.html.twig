{% extends 'base.html.twig' %}

{% block title %}Results - Quiz Trainer{% endblock %}

{% block body %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Result Header -->
    {% if session.mode == 'certification' %}
    <div class="text-center mb-8 animate-fade-in-up">
        {% if session.score >= 70 %}
        <div class="mb-4">
            <div class="inline-flex w-24 h-24 rounded-3xl bg-emerald-50 border-2 border-emerald-200 items-center justify-center shadow-lg shadow-emerald-500/10">
                <i class="fas fa-check text-4xl text-emerald-500"></i>
            </div>
        </div>
        <h1 class="text-3xl font-extrabold text-emerald-600 mb-2">üéâ PASSED!</h1>
        <p class="text-gray-500">Congratulations! Score : {{ session.score|number_format(1) }}% (threshold : 70%)</p>
        {% else %}
        <div class="mb-4">
            <div class="inline-flex w-24 h-24 rounded-3xl bg-red-50 border-2 border-red-200 items-center justify-center shadow-lg shadow-red-500/10">
                <i class="fas fa-times text-4xl text-red-500"></i>
            </div>
        </div>
        <h1 class="text-3xl font-extrabold text-red-600 mb-2">NOT PASSED</h1>
        <p class="text-gray-500">Score : {{ session.score|number_format(1) }}% ‚Äî You were missing {{ (70 - session.score)|number_format(1) }}%</p>
        {% endif %}
    </div>
    {% else %}
    <div class="text-center mb-8 animate-fade-in-up">
        {% if session.score >= 80 %}
        <div class="text-6xl mb-3 animate-float">üéâ</div>
        <h1 class="text-3xl font-extrabold text-emerald-600 mb-1">Excellent!</h1>
        {% elseif session.score >= 60 %}
        <div class="text-6xl mb-3 animate-float">üëç</div>
        <h1 class="text-3xl font-extrabold text-amber-500 mb-1">Well done!</h1>
        {% else %}
        <div class="text-6xl mb-3 animate-float">üìö</div>
        <h1 class="text-3xl font-extrabold text-red-500 mb-1">Keep practicing!</h1>
        {% endif %}
        <p class="text-gray-400 text-sm">Completed on {{ session.completedAt|date('m/d/Y H:i') }}</p>
    </div>
    {% endif %}

    <!-- Score Card -->
    <div class="card-modern p-8 mb-8 animate-fade-in-up stagger-1">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
            <div class="p-4">
                <div class="text-5xl font-black mb-1
                    {% if session.score >= 80 %}text-emerald-600
                    {% elseif session.score >= 60 %}text-amber-500
                    {% else %}text-red-500{% endif %}">
                    {{ session.score|number_format(0) }}%
                </div>
                <div class="text-gray-400 text-sm font-medium">Final Score</div>
            </div>
            
            <div class="p-4 md:border-x border-gray-100">
                <div class="flex justify-center items-center gap-4">
                    <div>
                        <div class="text-3xl font-extrabold text-emerald-600">{{ session.correctAnswers }}</div>
                        <div class="text-gray-400 text-xs font-medium">Correct</div>
                    </div>
                    <div class="text-gray-200 text-2xl font-light">/</div>
                    <div>
                        <div class="text-3xl font-extrabold text-red-500">{{ session.incorrectAnswers }}</div>
                        <div class="text-gray-400 text-xs font-medium">Incorrect</div>
                    </div>
                </div>
            </div>
            
            <div class="p-4">
                <div class="text-3xl font-extrabold text-gray-800">{{ session.formattedTimeSpent }}</div>
                <div class="text-gray-400 text-sm font-medium">Total Time</div>
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-100">
            <div class="flex flex-wrap justify-center gap-2">
                {% if session.mode == 'certification' %}
                <span class="bg-amber-50 text-amber-700 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1">
                    <i class="fas fa-certificate"></i> Certification Exam
                </span>
                {% endif %}
                <span class="bg-gray-50 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-medium">
                    <i class="fas fa-list-ol mr-1"></i> {{ session.totalQuestions }} Questions
                </span>
                {% if session.category %}
                <span class="bg-primary-50 text-primary-700 px-3 py-1.5 rounded-lg text-xs font-medium">
                    <i class="fas fa-folder mr-1"></i> {{ session.category.name }}
                </span>
                {% endif %}
                {% if session.subcategory %}
                <span class="bg-violet-50 text-violet-700 px-3 py-1.5 rounded-lg text-xs font-medium">
                    <i class="fas fa-tag mr-1"></i> {{ session.subcategory.name }}
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap justify-center gap-3 mb-8 animate-fade-in-up stagger-2">
        {% if session.mode == 'certification' %}
        <a href="{{ path('quiz_certification_exam') }}" 
           class="bg-gradient-to-r from-amber-500 to-orange-500 text-white px-5 py-3 rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-amber-500/25 hover:-translate-y-0.5 transition-all flex items-center gap-2">
            <i class="fas fa-certificate"></i> {% if session.score >= 70 %}New Exam{% else %}Retry{% endif %}
        </a>
        {% endif %}
        <a href="{{ path('quiz_start_form') }}" 
           class="bg-gradient-to-r from-primary-500 to-primary-600 text-white px-5 py-3 rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-primary-500/25 hover:-translate-y-0.5 transition-all flex items-center gap-2">
            <i class="fas fa-redo"></i> New Quiz
        </a>
        <a href="{{ path('quiz_review', {id: session.id}) }}" 
           class="bg-white text-primary-600 border-2 border-primary-200 px-5 py-3 rounded-xl font-bold text-sm hover:bg-primary-50 hover:-translate-y-0.5 transition-all flex items-center gap-2">
            <i class="fas fa-eye"></i> Review Answers
        </a>
        <a href="{{ path('statistics_dashboard') }}" 
           class="bg-gray-50 text-gray-600 px-5 py-3 rounded-xl font-bold text-sm hover:bg-gray-100 hover:-translate-y-0.5 transition-all flex items-center gap-2">
            <i class="fas fa-chart-bar"></i> Statistics
        </a>
    </div>

    <!-- Answer Summary -->
    <div class="card-modern overflow-hidden animate-fade-in-up stagger-3">
        <div class="bg-gray-50/80 px-6 py-4 border-b border-gray-100">
            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-list-check text-primary-500"></i> Answer Summary
            </h2>
        </div>
        <div class="divide-y divide-gray-50">
            {% for answer in answers %}
            <div class="p-4 flex items-start gap-3 {{ answer.isCorrect ? 'bg-emerald-50/30' : 'bg-red-50/30' }} hover:bg-opacity-60 transition-colors">
                <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-xl
                    {{ answer.isCorrect ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600' }} text-sm font-bold">
                    <i class="fas {{ answer.isCorrect ? 'fa-check' : 'fa-times' }}"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-gray-700 text-sm font-medium mb-1 question-text line-clamp-2">
                        {{ answer.question.text|truncate_question(1500) }}
                    </div>
                    <div class="flex items-center gap-3 text-xs">
                        <span class="{{ answer.isCorrect ? 'text-emerald-600' : 'text-red-500' }} font-medium">
                            {{ answer.isCorrect ? 'Correct' : 'Incorrect' }}
                        </span>
                        <span class="text-gray-400">
                            <i class="fas fa-stopwatch mr-0.5"></i> {{ answer.timeSpentSeconds }}s
                        </span>
                        {% if answer.question.symfonyVersion %}
                        <span class="text-cyan-500 font-medium">
                            <i class="fas fa-bolt mr-0.5"></i> {{ answer.question.symfonyVersion }}
                        </span>
                        {% endif %}
                        <button type="button" onclick="toggleQuestionActive({{ answer.question.id }}, this)" 
                                class="toggle-active-btn {{ answer.question.isActive ? 'text-emerald-500 hover:text-red-500' : 'text-red-400 hover:text-emerald-500' }} transition font-medium">
                            <i class="fas {{ answer.question.isActive ? 'fa-eye' : 'fa-eye-slash' }} mr-0.5"></i>
                            {{ answer.question.isActive ? 'Active' : 'Inactive' }}
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% block javascripts %}
<script>
async function toggleQuestionActive(questionId, button) {
    try {
        const response = await fetch(`/api/question/${questionId}/toggle-active`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await response.json();
        if (data.success) {
            if (data.isActive) {
                button.className = 'toggle-active-btn text-emerald-500 hover:text-red-500 transition font-medium';
                button.innerHTML = '<i class="fas fa-eye mr-0.5"></i> Active';
            } else {
                button.className = 'toggle-active-btn text-red-400 hover:text-emerald-500 transition font-medium';
                button.innerHTML = '<i class="fas fa-eye-slash mr-0.5"></i> Inactive';
            }
            showNotification(data.message, 'success');
        }
    } catch (error) { showNotification('Error', 'error'); }
}

function showNotification(message, type) {
    const n = document.createElement('div');
    n.className = `fixed top-4 right-4 px-5 py-3 rounded-xl shadow-2xl z-[100] text-white font-medium text-sm backdrop-blur-sm ${type === 'success' ? 'bg-emerald-600/95' : 'bg-red-600/95'}`;
    n.style.animation = 'fadeInUp 0.3s ease-out';
    n.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>${message}`;
    document.body.appendChild(n);
    setTimeout(() => { n.style.opacity = '0'; n.style.transition = 'opacity 0.3s'; setTimeout(() => n.remove(), 300); }, 3000);
}
</script>
{% endblock %}
{% endblock %}
