{% extends 'base.html.twig' %}

{% block title %}{{ question ? 'Edit question #' ~ question.id : 'New question' }} - Admin{% endblock %}

{% block body %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8 animate-fade-in-up">
        <a href="{{ path('admin_question_index') }}" class="inline-flex items-center gap-2 text-primary-500 hover:text-primary-400 mb-4 transition group">
            <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
            <span>Back to questions</span>
        </a>
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white flex items-center gap-3">
            <span class="w-10 h-10 flex items-center justify-center bg-gradient-to-br from-primary-500 to-violet-500 rounded-xl text-white">
                <i class="fas {{ question ? 'fa-edit' : 'fa-plus' }}"></i>
            </span>
            {{ question ? 'Edit question #' ~ question.id : 'New question' }}
        </h1>
    </div>

    <form method="POST" class="space-y-6">
        <input type="hidden" name="_token" value="{{ csrf_token('question_form') }}">

        <!-- Question Text -->
        <div class="card-modern p-6 animate-fade-in-up stagger-1">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <span class="w-8 h-8 flex items-center justify-center bg-primary-100 dark:bg-primary-900/30 rounded-lg">
                    <i class="fas fa-question text-primary-500 text-sm"></i>
                </span>
                Question text
            </h2>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                    Question <span class="text-red-500">*</span>
                </label>
                <textarea name="text" rows="6" required
                    class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent font-mono text-sm transition text-gray-900 dark:text-white"
                    placeholder="Enter the question text. HTML supported for code blocks.">{{ formData.text ?? question.text ?? '' }}</textarea>
                <p class="text-xs text-gray-500 mt-1.5">
                    <i class="fas fa-info-circle mr-1"></i> Supports HTML. Use <code class="bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded text-xs">&lt;pre&gt;&lt;code class="language-php"&gt;...&lt;/code&gt;&lt;/pre&gt;</code> for code blocks.
                </p>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Explanation</label>
                <textarea name="explanation" rows="3"
                    class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white"
                    placeholder="Explain why the correct answer is right...">{{ formData.explanation ?? question.explanation ?? '' }}</textarea>
            </div>
        </div>

        <!-- Category & Type -->
        <div class="card-modern p-6 animate-fade-in-up stagger-2">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <span class="w-8 h-8 flex items-center justify-center bg-violet-100 dark:bg-violet-900/30 rounded-lg">
                    <i class="fas fa-tag text-violet-500 text-sm"></i>
                </span>
                Classification
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Category <span class="text-red-500">*</span>
                    </label>
                    <div class="flex gap-2">
                        <select name="category" id="categorySelect" required
                            class="flex-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white">
                            <option value="">Select a category</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" 
                                    {{ (formData.category ?? question.category.id ?? '') == category.id ? 'selected' : '' }}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="button" id="addCategoryBtn" class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 px-3 py-2 rounded-xl hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition" title="Add a category">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Subcategory <span class="text-red-500">*</span>
                    </label>
                    <div class="flex gap-2">
                        <select name="subcategory" id="subcategorySelect" required
                            class="flex-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white">
                            <option value="">Select a subcategory</option>
                            {% for sub in subcategories %}
                                <option value="{{ sub.id }}"
                                    {{ (formData.subcategory ?? question.subcategory.id ?? '') == sub.id ? 'selected' : '' }}>
                                    {{ sub.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="button" id="addSubcategoryBtn" class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 px-3 py-2 rounded-xl hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition disabled:opacity-50 disabled:cursor-not-allowed" title="Add a subcategory" disabled>
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Type <span class="text-red-500">*</span></label>
                    <select name="type" required class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white">
                        {% for qType in questionTypes %}
                            <option value="{{ qType.value }}" {{ (formData.type ?? question.type ?? '') == qType.value ? 'selected' : '' }}>{{ qType.label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Difficulty <span class="text-red-500">*</span></label>
                    <select name="difficulty" required class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white">
                        <option value="1" {{ (formData.difficulty ?? question.difficulty ?? 1) == 1 ? 'selected' : '' }}>1 - Easy</option>
                        <option value="2" {{ (formData.difficulty ?? question.difficulty ?? 1) == 2 ? 'selected' : '' }}>2 - Medium</option>
                        <option value="3" {{ (formData.difficulty ?? question.difficulty ?? 1) == 3 ? 'selected' : '' }}>3 - Hard</option>
                        <option value="4" {{ (formData.difficulty ?? question.difficulty ?? 1) == 4 ? 'selected' : '' }}>4 - Very hard</option>
                        <option value="5" {{ (formData.difficulty ?? question.difficulty ?? 1) == 5 ? 'selected' : '' }}>5 - Expert</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Certification</label>
                    <label class="flex items-center mt-3 cursor-pointer">
                        <input type="checkbox" name="is_certification" value="1" 
                            {{ (formData.is_certification ?? question.isCertification ?? false) ? 'checked' : '' }}
                            class="rounded text-primary-500 focus:ring-primary-500 h-5 w-5 border-gray-300 dark:border-gray-600">
                        <span class="ml-2 text-gray-700 dark:text-gray-300">Certification question</span>
                    </label>
                </div>
            </div>

            <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Symfony Version</label>
                <select name="symfony_version" class="w-full md:w-1/3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white">
                    <option value="">No version</option>
                    {% for sv in symfonyVersions %}
                        <option value="{{ sv.value }}" {{ (formData.symfony_version ?? question.symfonyVersion ?? '') == sv.value ? 'selected' : '' }}>{{ sv.label }}</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1.5"><i class="fas fa-info-circle mr-1"></i> Tag this question with a specific Symfony version (e.g. 7.4/8.0 new features)</p>
            </div>
        </div>

        <!-- Resource URL -->
        <div class="card-modern p-6 animate-fade-in-up stagger-3">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <span class="w-8 h-8 flex items-center justify-center bg-cyan-100 dark:bg-cyan-900/30 rounded-lg">
                    <i class="fas fa-link text-cyan-500 text-sm"></i>
                </span>
                Resources
            </h2>
            <textarea name="resource_url" rows="2"
                class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white"
                placeholder="https://symfony.com/doc/...">{{ formData.resource_url ?? question.resourceUrl ?? '' }}</textarea>
            <p class="text-xs text-gray-500 mt-1.5">
                <i class="fas fa-info-circle mr-1"></i> Separate multiple URLs with commas
            </p>
        </div>

        <!-- Answers -->
        <div class="card-modern p-6 animate-fade-in-up stagger-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <span class="w-8 h-8 flex items-center justify-center bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
                        <i class="fas fa-list-check text-emerald-500 text-sm"></i>
                    </span>
                    Answers
                </h2>
                <button type="button" id="addAnswerBtn" class="bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 px-3 py-1.5 rounded-lg text-sm hover:bg-primary-200 dark:hover:bg-primary-900/50 transition font-medium">
                    <i class="fas fa-plus mr-1"></i> Add
                </button>
            </div>
            
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                <i class="fas fa-info-circle mr-1"></i> Check the correct answers. Minimum 2 answers required.
            </p>

            <div id="answersContainer" class="space-y-3">
                {% set existingAnswers = formData.answers ?? (question ? question.answers : []) %}
                {% if existingAnswers is empty %}
                    {% for i in 0..3 %}
                    <div class="answer-row flex items-center gap-3 p-3.5 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                        <input type="checkbox" name="answers[{{ i }}][correct]" value="1" 
                            class="rounded text-emerald-500 focus:ring-emerald-500 h-5 w-5 flex-shrink-0 border-gray-300 dark:border-gray-600">
                        <input type="text" name="answers[{{ i }}][text]" placeholder="Answer {{ i + 1 }}"
                            class="flex-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white">
                        <button type="button" class="remove-answer text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition" title="Delete">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    {% for key, answer in existingAnswers %}
                        {% if answer is iterable %}
                            <div class="answer-row flex items-center gap-3 p-3.5 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                                <input type="checkbox" name="answers[{{ key }}][correct]" value="1" 
                                    {{ answer.correct is defined and answer.correct ? 'checked' : '' }}
                                    class="rounded text-emerald-500 focus:ring-emerald-500 h-5 w-5 flex-shrink-0 border-gray-300 dark:border-gray-600">
                                <input type="text" name="answers[{{ key }}][text]" value="{{ answer.text ?? '' }}" placeholder="Answer"
                                    class="flex-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white">
                                <button type="button" class="remove-answer text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition" title="Delete">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        {% else %}
                            <div class="answer-row flex items-center gap-3 p-3.5 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700">
                                <input type="checkbox" name="answers[{{ loop.index0 }}][correct]" value="1" 
                                    {{ answer.isCorrect ? 'checked' : '' }}
                                    class="rounded text-emerald-500 focus:ring-emerald-500 h-5 w-5 flex-shrink-0 border-gray-300 dark:border-gray-600">
                                <input type="text" name="answers[{{ loop.index0 }}][text]" value="{{ answer.text }}" placeholder="Answer"
                                    class="flex-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white">
                                <button type="button" class="remove-answer text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition" title="Delete">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- Submit -->
        <div class="flex items-center justify-between animate-fade-in-up stagger-5">
            <a href="{{ path('admin_question_index') }}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition">
                <i class="fas fa-times mr-2"></i> Cancel
            </a>
            <button type="submit" class="btn-primary px-6 py-3 rounded-xl font-semibold">
                <i class="fas fa-save mr-2"></i> {{ question ? 'Update' : 'Create question' }}
            </button>
        </div>
    </form>
</div>

<!-- Modal: Add Category -->
<div id="categoryModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="card-modern max-w-md w-full mx-4 overflow-hidden">
        <div class="bg-gradient-to-r from-primary-500 to-violet-500 px-6 py-4 flex items-center justify-between">
            <h3 class="text-lg font-bold text-white">
                <i class="fas fa-folder-plus mr-2"></i> New category
            </h3>
            <button type="button" class="close-modal text-white/70 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Name <span class="text-red-500">*</span></label>
                <input type="text" id="newCategoryName" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white" placeholder="ex: Symfony, PHP, JavaScript">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Description</label>
                <input type="text" id="newCategoryDescription" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white" placeholder="Short description (optional)">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Icon</label>
                <input type="text" id="newCategoryIcon" value="folder" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white" placeholder="Font Awesome icon name">
            </div>
            <div id="categoryError" class="hidden text-sm text-red-600 bg-red-50 dark:bg-red-900/20 p-3 rounded-xl"></div>
        </div>
        <div class="px-6 py-4 border-t border-gray-100 dark:border-gray-700 flex justify-end gap-3">
            <button type="button" class="close-modal px-4 py-2 text-gray-500 hover:text-gray-700 transition">Cancel</button>
            <button type="button" id="saveCategoryBtn" class="btn-primary px-4 py-2 rounded-xl">
                <i class="fas fa-save mr-2"></i> Create
            </button>
        </div>
    </div>
</div>

<!-- Modal: Add Subcategory -->
<div id="subcategoryModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="card-modern max-w-md w-full mx-4 overflow-hidden">
        <div class="bg-gradient-to-r from-primary-500 to-violet-500 px-6 py-4 flex items-center justify-between">
            <h3 class="text-lg font-bold text-white">
                <i class="fas fa-tag mr-2"></i> New subcategory
            </h3>
            <button type="button" class="close-modal text-white/70 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Category parente</label>
                <div id="subcategoryParent" class="bg-gray-100 dark:bg-gray-700 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 font-medium"></div>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Name <span class="text-red-500">*</span></label>
                <input type="text" id="newSubcategoryName" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white" placeholder="ex: Routing, Controllers, Events">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Description</label>
                <input type="text" id="newSubcategoryDescription" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white" placeholder="Short description (optional)">
            </div>
            <div id="subcategoryError" class="hidden text-sm text-red-600 bg-red-50 dark:bg-red-900/20 p-3 rounded-xl"></div>
        </div>
        <div class="px-6 py-4 border-t border-gray-100 dark:border-gray-700 flex justify-end gap-3">
            <button type="button" class="close-modal px-4 py-2 text-gray-500 hover:text-gray-700 transition">Cancel</button>
            <button type="button" id="saveSubcategoryBtn" class="btn-primary px-4 py-2 rounded-xl">
                <i class="fas fa-save mr-2"></i> Create
            </button>
        </div>
    </div>
</div>

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('categorySelect');
    const subcategorySelect = document.getElementById('subcategorySelect');
    const answersContainer = document.getElementById('answersContainer');
    const addAnswerBtn = document.getElementById('addAnswerBtn');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const addSubcategoryBtn = document.getElementById('addSubcategoryBtn');

    // Category -> Subcategory cascade
    categorySelect.addEventListener('change', async function() {
        const categoryId = this.value;
        subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
        addSubcategoryBtn.disabled = !categoryId;

        if (categoryId) {
            try {
                const response = await fetch(`/admin/questions/api/subcategories/${categoryId}`);
                const subcategories = await response.json();
                subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.id;
                    option.textContent = sub.name;
                    subcategorySelect.appendChild(option);
                });
            } catch (e) { console.error('Error loading subcategories:', e); }
        }
    });

    // Modal handling
    const categoryModal = document.getElementById('categoryModal');
    const subcategoryModal = document.getElementById('subcategoryModal');

    function openModal(modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.querySelector('input[type="text"]').focus();
    }

    function closeModal(modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        modal.querySelectorAll('input').forEach(i => i.value = '');
        modal.querySelector('[id$="Error"]').classList.add('hidden');
    }

    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', function() { closeModal(this.closest('[id$="Modal"]')); });
    });

    [categoryModal, subcategoryModal].forEach(modal => {
        modal.addEventListener('click', function(e) { if (e.target === this) closeModal(this); });
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') [categoryModal, subcategoryModal].forEach(closeModal);
    });

    // Add Category
    addCategoryBtn.addEventListener('click', () => openModal(categoryModal));

    document.getElementById('saveCategoryBtn').addEventListener('click', async function() {
        const name = document.getElementById('newCategoryName').value.trim();
        const description = document.getElementById('newCategoryDescription').value.trim();
        const icon = document.getElementById('newCategoryIcon').value.trim() || 'folder';
        const errorDiv = document.getElementById('categoryError');

        if (!name) { errorDiv.textContent = 'Name is required'; errorDiv.classList.remove('hidden'); return; }

        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Creating...';

        try {
            const response = await fetch('/admin/questions/api/categories', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description, icon })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Error during creation');

            const option = document.createElement('option');
            option.value = data.category.id;
            option.textContent = data.category.name;
            option.selected = true;
            categorySelect.appendChild(option);
            categorySelect.dispatchEvent(new Event('change'));
            closeModal(categoryModal);
        } catch (e) { errorDiv.textContent = e.message; errorDiv.classList.remove('hidden'); }
        finally { this.disabled = false; this.innerHTML = '<i class="fas fa-save mr-2"></i> Create'; }
    });

    // Add Subcategory
    addSubcategoryBtn.addEventListener('click', function() {
        const categoryId = categorySelect.value;
        const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
        if (!categoryId) return;
        document.getElementById('subcategoryParent').textContent = categoryName;
        document.getElementById('subcategoryParent').dataset.categoryId = categoryId;
        openModal(subcategoryModal);
    });

    document.getElementById('saveSubcategoryBtn').addEventListener('click', async function() {
        const name = document.getElementById('newSubcategoryName').value.trim();
        const description = document.getElementById('newSubcategoryDescription').value.trim();
        const categoryId = document.getElementById('subcategoryParent').dataset.categoryId;
        const errorDiv = document.getElementById('subcategoryError');

        if (!name) { errorDiv.textContent = 'Name is required'; errorDiv.classList.remove('hidden'); return; }

        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Creating...';

        try {
            const response = await fetch('/admin/questions/api/subcategories', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description, category_id: categoryId })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Error during creation');

            const option = document.createElement('option');
            option.value = data.subcategory.id;
            option.textContent = data.subcategory.name;
            option.selected = true;
            subcategorySelect.appendChild(option);
            closeModal(subcategoryModal);
        } catch (e) { errorDiv.textContent = e.message; errorDiv.classList.remove('hidden'); }
        finally { this.disabled = false; this.innerHTML = '<i class="fas fa-save mr-2"></i> Create'; }
    });

    // Add answer
    let answerIndex = answersContainer.querySelectorAll('.answer-row').length;
    addAnswerBtn.addEventListener('click', function() {
        const row = document.createElement('div');
        row.className = 'answer-row flex items-center gap-3 p-3.5 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700';
        row.innerHTML = `
            <input type="checkbox" name="answers[${answerIndex}][correct]" value="1" class="rounded text-emerald-500 focus:ring-emerald-500 h-5 w-5 flex-shrink-0 border-gray-300 dark:border-gray-600">
            <input type="text" name="answers[${answerIndex}][text]" placeholder="New answer" class="flex-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition text-gray-900 dark:text-white">
            <button type="button" class="remove-answer text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition" title="Delete"><i class="fas fa-times"></i></button>
        `;
        answersContainer.appendChild(row);
        answerIndex++;
        row.querySelector('input[type="text"]').focus();
    });

    answersContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-answer')) {
            const rows = answersContainer.querySelectorAll('.answer-row');
            if (rows.length > 2) e.target.closest('.answer-row').remove();
            else alert('Minimum 2 answers required.');
        }
    });

    if (categorySelect.value) addSubcategoryBtn.disabled = false;
});
</script>
{% endblock %}
{% endblock %}
