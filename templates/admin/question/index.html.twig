{% extends 'base.html.twig' %}

{% block title %}Questions Management - Admin{% endblock %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-question-circle text-indigo-600 mr-2"></i> Questions Management
            </h1>
            <p class="text-gray-500">Create, edit and manage quiz questions</p>
        </div>
        <div class="flex gap-3">
            <a href="{{ path('admin_category_index') }}" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                <i class="fas fa-folder-tree mr-2"></i> Categories
            </a>
            <a href="{{ path('admin_quiz_index') }}" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                <i class="fas fa-clipboard-list mr-2"></i> Quiz Sessions
            </a>
            <a href="{{ path('admin_question_new') }}" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                <i class="fas fa-plus mr-2"></i> New Question
            </a>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-xs uppercase">Total Questions</p>
                    <p class="text-2xl font-bold text-gray-800">{{ stats.total }}</p>
                </div>
                <div class="bg-indigo-100 p-2 rounded-lg">
                    <i class="fas fa-database text-indigo-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-xs uppercase">Single Choice</p>
                    <p class="text-2xl font-bold text-blue-600">{{ stats.byType['single_choice'] ?? 0 }}</p>
                </div>
                <div class="bg-blue-100 p-2 rounded-lg">
                    <i class="fas fa-circle-dot text-blue-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-xs uppercase">Multiple Choice</p>
                    <p class="text-2xl font-bold text-purple-600">{{ stats.byType['multiple_choice'] ?? 0 }}</p>
                </div>
                <div class="bg-purple-100 p-2 rounded-lg">
                    <i class="fas fa-square-check text-purple-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-xs uppercase">True / False</p>
                    <p class="text-2xl font-bold text-orange-600">{{ stats.byType['true_false'] ?? 0 }}</p>
                </div>
                <div class="bg-orange-100 p-2 rounded-lg">
                    <i class="fas fa-toggle-on text-orange-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-xs uppercase">Certification</p>
                    <p class="text-2xl font-bold text-green-600">{{ stats.certification }}</p>
                </div>
                <div class="bg-green-100 p-2 rounded-lg">
                    <i class="fas fa-certificate text-green-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow mb-6">
        <div class="p-4 border-b border-gray-200">
            <form method="GET" class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Search</label>
                    <input type="text" name="search" value="{{ filters.search }}" placeholder="Search in questions..."
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Category</label>
                    <select name="category" id="categoryFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {{ filters.category == category.id ? 'selected' : '' }}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Subcategory</label>
                    <select name="subcategory" id="subcategoryFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Subcategories</option>
                        {% for sub in subcategories %}
                            <option value="{{ sub.id }}" {{ filters.subcategory == sub.id ? 'selected' : '' }}>
                                {{ sub.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Type</label>
                    <select name="type" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Types</option>
                        {% for qType in questionTypes %}
                            <option value="{{ qType.value }}" {{ filters.type == qType.value ? 'selected' : '' }}>
                                {{ qType.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Difficulty</label>
                    <select name="difficulty" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Levels</option>
                        {% for i in 1..5 %}
                            <option value="{{ i }}" {{ filters.difficulty == i ? 'selected' : '' }}>
                                {{ i }} - {% if i == 1 %}Easy{% elseif i == 2 %}Medium{% elseif i == 3 %}Hard{% elseif i == 4 %}Very Hard{% else %}Expert{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Certification</label>
                    <select name="certification" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                        <option value="">All</option>
                        <option value="1" {{ filters.certification == '1' ? 'selected' : '' }}>Certification Only</option>
                        <option value="0" {{ filters.certification == '0' ? 'selected' : '' }}>Regular Only</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700 transition">
                        <i class="fas fa-filter mr-1"></i> Filter
                    </button>
                    <a href="{{ path('admin_question_index') }}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300 transition">
                        <i class="fas fa-times mr-1"></i> Clear
                    </a>
                </div>
            </form>
        </div>

        <!-- Bulk Actions -->
        <div class="p-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <label class="flex items-center">
                    <input type="checkbox" id="selectAll" class="rounded text-indigo-600 mr-2">
                    <span class="text-sm text-gray-600">Select All</span>
                </label>
                <span class="text-sm text-gray-400" id="selectedCount">0 selected</span>
            </div>

            <form action="{{ path('admin_question_bulk_delete') }}" method="POST" id="bulkDeleteForm" class="inline">
                <input type="hidden" name="_token" value="{{ csrf_token('bulk_delete') }}">
                <button type="submit" class="bg-red-100 text-red-600 px-3 py-1.5 rounded-lg text-sm hover:bg-red-200 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled id="bulkDeleteBtn">
                    <i class="fas fa-trash mr-1"></i> Delete Selected
                </button>
            </form>
        </div>

        <!-- Questions Table -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-10"></th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-16">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Question</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32">Category</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-24">Type</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-20">Diff.</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-20">Answers</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-28">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for question in questions %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <input type="checkbox" name="question_id" value="{{ question.id }}" class="question-checkbox rounded text-indigo-600">
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600 font-mono">#{{ question.id }}</td>
                        <td class="px-4 py-3">
                            <div class="flex items-start gap-2">
                                {% if question.isCertification %}
                                    <span class="bg-green-100 text-green-700 px-1.5 py-0.5 rounded text-xs font-medium flex-shrink-0">
                                        <i class="fas fa-certificate"></i>
                                    </span>
                                {% endif %}
                                <div class="min-w-0">
                                    <a href="{{ path('admin_question_show', {id: question.id}) }}" class="text-gray-900 hover:text-indigo-600 font-medium block truncate max-w-md" title="{{ question.text|striptags }}">
                                        {{ question.text|striptags|slice(0, 80) }}{% if question.text|length > 80 %}...{% endif %}
                                    </a>
                                    <div class="text-xs text-gray-400 mt-0.5">
                                        {{ question.subcategory.name }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {{ question.category.name }}
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium 
                                {% if question.type == 'single_choice' %}bg-blue-100 text-blue-700
                                {% elseif question.type == 'multiple_choice' %}bg-purple-100 text-purple-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                <i class="fas {{ question.typeEnum.icon }} mr-1"></i>
                                {{ question.typeEnum.label|split(' ')|first }}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex gap-0.5">
                                {% for i in 1..5 %}
                                    <i class="fas fa-star text-xs {{ i <= question.difficulty ? 'text-yellow-400' : 'text-gray-200' }}"></i>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            <span class="text-green-600">{{ question.correctAnswers|length }}</span>
                            <span class="text-gray-400">/</span>
                            {{ question.answers|length }}
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-1">
                                <a href="{{ path('admin_question_show', {id: question.id}) }}" 
                                   class="p-1.5 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ path('admin_question_edit', {id: question.id}) }}" 
                                   class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form action="{{ path('admin_question_duplicate', {id: question.id}) }}" method="POST" class="inline">
                                    <input type="hidden" name="_token" value="{{ csrf_token('duplicate' ~ question.id) }}">
                                    <button type="submit" class="p-1.5 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded" title="Duplicate">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </form>
                                <form action="{{ path('admin_question_delete', {id: question.id}) }}" method="POST" class="inline" 
                                      onsubmit="return confirm('Delete this question?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ question.id) }}">
                                    <button type="submit" class="p-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-4 py-12 text-center">
                            <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500 mb-4">No questions found</p>
                            <a href="{{ path('admin_question_new') }}" class="inline-flex items-center bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                                <i class="fas fa-plus mr-2"></i> Create First Question
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
            <div class="text-sm text-gray-500">
                Showing {{ ((pagination.page - 1) * pagination.limit) + 1 }} to {{ min(pagination.page * pagination.limit, pagination.total) }} of {{ pagination.total }} results
            </div>
            <div class="flex gap-1">
                {% if pagination.page > 1 %}
                    <a href="{{ path('admin_question_index', filters|merge({page: pagination.page - 1})) }}" 
                       class="px-3 py-1 rounded bg-white border border-gray-300 text-sm hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                {% endif %}

                {% for p in range(max(1, pagination.page - 2), min(pagination.pages, pagination.page + 2)) %}
                    <a href="{{ path('admin_question_index', filters|merge({page: p})) }}" 
                       class="px-3 py-1 rounded text-sm {{ p == pagination.page ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-300 hover:bg-gray-50' }}">
                        {{ p }}
                    </a>
                {% endfor %}

                {% if pagination.page < pagination.pages %}
                    <a href="{{ path('admin_question_index', filters|merge({page: pagination.page + 1})) }}" 
                       class="px-3 py-1 rounded bg-white border border-gray-300 text-sm hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Selection handling
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.question-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const bulkDeleteForm = document.getElementById('bulkDeleteForm');

    function updateSelection() {
        const checked = document.querySelectorAll('.question-checkbox:checked');
        selectedCount.textContent = checked.length + ' selected';
        bulkDeleteBtn.disabled = checked.length === 0;
    }

    selectAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateSelection();
    });

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelection);
    });

    bulkDeleteForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!confirm('Delete selected questions?')) return;

        const checked = document.querySelectorAll('.question-checkbox:checked');
        checked.forEach(cb => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ids[]';
            input.value = cb.value;
            this.appendChild(input);
        });

        this.submit();
    });

    // Category -> Subcategory cascade
    const categoryFilter = document.getElementById('categoryFilter');
    const subcategoryFilter = document.getElementById('subcategoryFilter');

    categoryFilter.addEventListener('change', async function() {
        const categoryId = this.value;
        subcategoryFilter.innerHTML = '<option value="">All Subcategories</option>';

        if (categoryId) {
            try {
                const response = await fetch(`/admin/questions/api/subcategories/${categoryId}`);
                const subcategories = await response.json();
                
                subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.id;
                    option.textContent = sub.name;
                    subcategoryFilter.appendChild(option);
                });
            } catch (e) {
                console.error('Failed to load subcategories:', e);
            }
        }
    });
});
</script>
{% endblock %}
{% endblock %}
