{% extends 'base.html.twig' %}

{% block title %}Revision Strategy - Symfony Certification{% endblock %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br via-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        <i class="fas fa-graduation-cap text-indigo-600 mr-3"></i>
                        Revision Strategy
                    </h1>
                    <p class="mt-2 text-gray-600">Personalized plan to pass the Symfony certification</p>
                </div>
                <a href="{{ path('quiz_start_form') }}" 
                   class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    <i class="fas fa-play mr-2"></i>
                    Start a Quiz
                </a>
            </div>
        </div>

        <!-- Readiness Score -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                <h2 class="text-xl font-bold text-white">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    Readiness Score
                </h2>
            </div>
            <div class="p-6">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <!-- Main Score -->
                    <div class="text-center">
                        <div class="relative inline-flex">
                            <svg class="w-36 h-36">
                                <circle cx="72" cy="72" r="60" stroke="#e5e7eb" stroke-width="12" fill="none"/>
                                <circle cx="72" cy="72" r="60" 
                                        stroke="{% if strategy.readinessScore.status == 'ready' %}#10B981{% elseif strategy.readinessScore.status == 'almost-ready' %}#F59E0B{% elseif strategy.readinessScore.status == 'in-progress' %}#6366F1{% else %}#EF4444{% endif %}" 
                                        stroke-width="12" 
                                        fill="none"
                                        stroke-linecap="round"
                                        stroke-dasharray="{{ strategy.readinessScore.score * 3.77 }} 377"
                                        transform="rotate(-90 72 72)"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-3xl font-bold text-gray-800">{{ strategy.readinessScore.score|number_format(1) }}%</span>
                            </div>
                        </div>
                        <p class="mt-2 text-lg font-semibold 
                            {% if strategy.readinessScore.status == 'ready' %}text-green-600
                            {% elseif strategy.readinessScore.status == 'almost-ready' %}text-amber-600
                            {% elseif strategy.readinessScore.status == 'in-progress' %}text-indigo-600
                            {% else %}text-red-600{% endif %}">
                            {{ strategy.readinessScore.message }}
                        </p>
                    </div>

                    <!-- Score Breakdown -->
                    <div class="flex-1 grid grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">{{ strategy.readinessScore.coverageScore|number_format(1) }}%</div>
                            <div class="text-sm text-gray-600">Coverage <span class="text-xs text-gray-400">(×20%)</span></div>
                            <div class="text-xs text-gray-400">Unique questions seen</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">{{ strategy.readinessScore.performanceScore|number_format(1) }}%</div>
                            <div class="text-sm text-gray-600">Performance <span class="text-xs text-gray-400">(×60%)</span></div>
                            <div class="text-xs text-gray-400">Success rate</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600">{{ strategy.readinessScore.consistencyScore|number_format(1) }}%</div>
                            <div class="text-sm text-gray-600">Consistency <span class="text-xs text-gray-400">(×20%)</span></div>
                            <div class="text-xs text-gray-400">Topic balance</div>
                        </div>
                    </div>

                    <!-- Certification Stats -->
                    <div class="text-center p-6 bg-gray-50 rounded-lg">
                        <div class="text-4xl font-bold {% if strategy.overallStats.bestCertScore >= 70 %}text-green-600{% else %}text-gray-600{% endif %}">
                            {{ strategy.overallStats.bestCertScore }}%
                        </div>
                        <div class="text-sm text-gray-600 mt-1">Best cert score</div>
                        <div class="text-xs text-gray-400 mt-2">
                            {{ strategy.overallStats.certificationAttempts }} simulation(s)
                        </div>
                        <div class="mt-2 text-xs {% if strategy.overallStats.bestCertScore >= 70 %}text-green-600{% else %}text-amber-600{% endif %}">
                            Passing threshold: 70%
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-3 bg-indigo-100 rounded-lg">
                        <i class="fas fa-question-circle text-indigo-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <div class="text-2xl font-bold text-gray-800">{{ strategy.practiceStats.questionsAttempted }}</div>
                        <div class="text-sm text-gray-500">Questions answered</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-eye text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <div class="text-2xl font-bold text-gray-800">{{ strategy.practiceStats.uniqueQuestionsAttempted }}</div>
                        <div class="text-sm text-gray-500">Unique questions</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-3 bg-amber-100 rounded-lg">
                        <i class="fas fa-database text-amber-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <div class="text-2xl font-bold text-gray-800">{{ strategy.practiceStats.totalQuestionsInDb }}</div>
                        <div class="text-sm text-gray-500">Available questions</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-percentage text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <div class="text-2xl font-bold text-gray-800">{{ strategy.practiceStats.coveragePercentage }}%</div>
                        <div class="text-sm text-gray-500">Coverage</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Recommendations -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="bg-amber-50 px-6 py-4 border-b border-amber-100">
                    <h2 class="text-xl font-bold text-amber-800">
                        <i class="fas fa-lightbulb mr-2"></i>
                        Personalized Recommendations
                    </h2>
                </div>
                <div class="p-6">
                    {% if strategy.recommendations|length > 0 %}
                    <div class="space-y-4">
                        {% for rec in strategy.recommendations %}
                        <div class="flex items-start p-4 rounded-lg 
                            {% if rec.priority == 'high' %}bg-red-50 border-l-4 border-red-500
                            {% elseif rec.priority == 'medium' %}bg-amber-50 border-l-4 border-amber-500
                            {% else %}bg-green-50 border-l-4 border-green-500{% endif %}">
                            <div class="flex-shrink-0 mr-4">
                                {% if rec.type == 'practice' %}
                                <i class="fas fa-dumbbell text-2xl {% if rec.priority == 'high' %}text-red-500{% else %}text-gray-500{% endif %}"></i>
                                {% elseif rec.type == 'focus' %}
                                <i class="fas fa-crosshairs text-2xl {% if rec.priority == 'high' %}text-red-500{% else %}text-gray-500{% endif %}"></i>
                                {% elseif rec.type == 'exam' %}
                                <i class="fas fa-file-alt text-2xl text-amber-500"></i>
                                {% elseif rec.type == 'study' %}
                                <i class="fas fa-book text-2xl text-blue-500"></i>
                                {% elseif rec.type == 'success' %}
                                <i class="fas fa-trophy text-2xl text-green-500"></i>
                                {% endif %}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">{{ rec.title }}</h4>
                                <p class="text-sm text-gray-600 mt-1">{{ rec.description }}</p>
                                {% if rec.action %}
                                    {% if rec.actionUrl %}
                                    <a href="{{ rec.actionUrl }}" target="_blank" rel="noopener noreferrer"
                                       class="inline-flex items-center mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-800">
                                        {{ rec.action }} <i class="fas fa-external-link-alt ml-1"></i>
                                    </a>
                                    {% elseif rec.actionRoute is defined and rec.actionRoute %}
                                    <a href="{{ path(rec.actionRoute, rec.actionRouteParams|default({})) }}" 
                                       class="inline-flex items-center mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-800">
                                        {{ rec.action }} <i class="fas fa-arrow-right ml-1"></i>
                                    </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-center py-4">Start practicing to receive personalized recommendations.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Daily Goals -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="bg-green-50 px-6 py-4 border-b border-green-100">
                    <h2 class="text-xl font-bold text-green-800">
                        <i class="fas fa-bullseye mr-2"></i>
                        Daily Goals
                    </h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        {% for goal in strategy.dailyGoals %}
                        <div class="flex items-start p-4 bg-gray-50 rounded-lg">
                            <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-{{ goal.icon }} text-green-600 text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">{{ goal.title }}</h4>
                                <p class="text-indigo-600 font-medium">{{ goal.target }}</p>
                                <p class="text-sm text-gray-500 mt-1">{{ goal.reason }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Topic Analysis -->
        <div class="bg-white rounded-xl shadow overflow-hidden mb-8">
            <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100">
                <h2 class="text-xl font-bold text-indigo-800">
                    <i class="fas fa-chart-pie mr-2"></i>
                    Topic Analysis by Certification Subject
                </h2>
                <p class="text-sm text-indigo-600 mt-1">
                    Based on <a href="https://certification.symfony.com/exams/symfony.html" target="_blank" rel="noopener noreferrer" class="underline hover:text-indigo-800">official Symfony exam topics</a>
                    — 75 questions, 14 topics, 90 minutes
                </p>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    {% for topic, data in strategy.topicAnalysis %}
                    <div class="border rounded-lg p-4 
                        {% if not data.inExam %}border-gray-300 bg-gray-50 opacity-75
                        {% elseif data.status == 'weak' %}border-red-200 bg-red-50
                        {% elseif data.status == 'moderate' %}border-amber-200 bg-amber-50
                        {% elseif data.status == 'strong' %}border-green-200 bg-green-50
                        {% else %}border-gray-200{% endif %}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center flex-wrap gap-2">
                                <span class="font-semibold text-gray-800">{{ topic }}</span>
                                {% if data.inExam %}
                                <span class="px-2 py-0.5 text-xs rounded-full bg-indigo-100 text-indigo-700">{{ data.weight }}% of exam</span>
                                {% else %}
                                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-200 text-gray-500">
                                    <i class="fas fa-ban mr-1"></i>Not in official exam
                                </span>
                                {% endif %}
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm {% if data.averageScore >= 80 %}text-green-600{% elseif data.averageScore >= 60 %}text-amber-600{% elseif data.averageScore > 0 %}text-red-600{% else %}text-gray-400{% endif %}">
                                    {% if data.averageScore > 0 %}{{ data.averageScore }}%{% else %}-{% endif %}
                                </span>
                                <span class="px-2 py-1 text-xs rounded 
                                    {% if data.status == 'strong' %}bg-green-100 text-green-700
                                    {% elseif data.status == 'moderate' %}bg-amber-100 text-amber-700
                                    {% elseif data.status == 'weak' %}bg-red-100 text-red-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {% if data.status == 'strong' %}Mastered
                                    {% elseif data.status == 'moderate' %}Needs Review
                                    {% elseif data.status == 'weak' %}Needs Work
                                    {% else %}Not Started{% endif %}
                                </span>
                            </div>
                        </div>
                        <!-- Progress bar for coverage -->
                        <div class="mt-2">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>Coverage</span>
                                <span>{{ data.coverage }}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full {% if data.coverage >= 80 %}bg-green-500{% elseif data.coverage >= 50 %}bg-amber-500{% else %}bg-red-500{% endif %}" 
                                     style="width: {{ data.coverage }}%"></div>
                            </div>
                        </div>
                        <!-- Subtopics -->
                        {% if data.subtopics|length > 0 %}
                        <div class="mt-3 flex flex-wrap gap-2">
                            {% for subtopic in data.subtopics %}
                            <span class="inline-flex items-center px-2 py-1 text-xs rounded-full
                                {% if subtopic.successRate >= 80 %}bg-green-100 text-green-700
                                {% elseif subtopic.successRate >= 60 %}bg-amber-100 text-amber-700
                                {% elseif subtopic.attempted > 0 %}bg-red-100 text-red-700
                                {% else %}bg-gray-100 text-gray-500{% endif %}"
                                title="{{ subtopic.name }}: {{ subtopic.uniqueSeen }}/{{ subtopic.available }} questions seen ({{ subtopic.coverage }}% coverage){% if subtopic.attempted > 0 %}, {{ subtopic.successRate }}% success on {{ subtopic.attempted }} answers{% endif %}">
                                {{ subtopic.name }}
                                {% if subtopic.attempted > 0 %}
                                <span class="ml-1 font-medium">{{ subtopic.successRate }}%</span>
                                {% endif %}
                                {% if subtopic.available > 0 %}
                                <span class="ml-1 opacity-60">({{ subtopic.uniqueSeen }}/{{ subtopic.available }})</span>
                                {% endif %}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Weekly Plan -->
        <div class="bg-white rounded-xl shadow overflow-hidden mb-8">
            <div class="bg-purple-50 px-6 py-4 border-b border-purple-100">
                <h2 class="text-xl font-bold text-purple-800">
                    <i class="fas fa-calendar-week mr-2"></i>
                    Weekly Revision Plan
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
                    {% for day in strategy.weeklyPlan %}
                    <div class="rounded-lg p-4 {% if loop.index == 6 %}bg-indigo-50{% elseif loop.index == 7 %}bg-green-50{% else %}bg-gray-50{% endif %}">
                        <div class="font-semibold text-gray-800 mb-2 text-center">{{ day.day }}</div>
                        <div class="text-sm text-indigo-600 font-medium mb-3 text-center">{{ day.focus }}</div>
                        <div class="space-y-2">
                            {% for activity in day.activities %}
                            <div class="flex items-start text-xs">
                                {% if activity.type == 'study' %}
                                <i class="fas fa-book text-blue-500 mr-2 mt-0.5"></i>
                                {% elseif activity.type == 'practice' %}
                                <i class="fas fa-tasks text-green-500 mr-2 mt-0.5"></i>
                                {% elseif activity.type == 'review' %}
                                <i class="fas fa-redo text-amber-500 mr-2 mt-0.5"></i>
                                {% elseif activity.type == 'exam' %}
                                <i class="fas fa-file-alt text-purple-500 mr-2 mt-0.5"></i>
                                {% elseif activity.type == 'rest' %}
                                <i class="fas fa-coffee text-gray-400 mr-2 mt-0.5"></i>
                                {% endif %}
                                <div>
                                    <span class="text-gray-700">{{ activity.description }}</span>
                                    {% if activity.duration > 0 %}
                                    <span class="text-gray-400 block">({{ activity.duration }}min)</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Priority Topics -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Weak Areas to Focus -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="bg-red-50 px-6 py-4 border-b border-red-100">
                    <h2 class="text-xl font-bold text-red-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Priority Areas to Improve
                    </h2>
                </div>
                <div class="p-6">
                    {% if strategy.priorityTopics.weakAreas|length > 0 %}
                    <div class="space-y-3">
                        {% for area in strategy.priorityTopics.weakAreas|slice(0, 8) %}
                        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                            <div class="flex-1">
                                <span class="text-gray-800">{{ area.name }}</span>
                                {% if area.documentationUrl %}
                                <a href="{{ area.documentationUrl }}" target="_blank" rel="noopener noreferrer"
                                   class="inline-flex items-center ml-2 text-xs text-indigo-600 hover:text-indigo-800">
                                    <i class="fas fa-book mr-1"></i>Documentation
                                    <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                                </a>
                                {% endif %}
                            </div>
                            <span class="text-red-600 font-semibold">{{ area.averageScore|number_format(1) }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
                        <p>No weak areas detected! Excellent work!</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Not Yet Attempted -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
                    <h2 class="text-xl font-bold text-blue-800">
                        <i class="fas fa-compass mr-2"></i>
                        Unexplored Topics
                    </h2>
                </div>
                <div class="p-6">
                    {% if strategy.priorityTopics.notAttemptedSubcategories|length > 0 %}
                    <div class="flex flex-wrap gap-2">
                        {% for subcat in strategy.priorityTopics.notAttemptedSubcategories %}
                        <div class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
                            <a href="{{ path('quiz_start_form') }}?subcategory={{ subcat.id }}" 
                               class="hover:text-blue-900 transition">
                                {{ subcat.category }} - {{ subcat.name }}
                                <i class="fas fa-arrow-right ml-1 text-xs"></i>
                            </a>
                            {% if subcat.documentationUrl %}
                            <a href="{{ subcat.documentationUrl }}" target="_blank" rel="noopener noreferrer"
                               class="ml-2 text-indigo-600 hover:text-indigo-800" title="Documentation">
                                <i class="fas fa-book"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-trophy text-4xl text-amber-500 mb-2"></i>
                        <p>You've explored all topics!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Most Failed Questions -->
        {% if strategy.priorityTopics.mostFailedQuestions|length > 0 %}
        <div class="bg-white rounded-xl shadow overflow-hidden mb-8">
            <div class="bg-orange-50 px-6 py-4 border-b border-orange-100">
                <h2 class="text-xl font-bold text-orange-800">
                    <i class="fas fa-times-circle mr-2"></i>
                    Most Failed Questions
                </h2>
            </div>
            <div class="p-6">
                <div class="space-y-3">
                    {% for q in strategy.priorityTopics.mostFailedQuestions|slice(0, 5) %}
                    <div class="p-4 border border-orange-200 rounded-lg">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 pr-4">
                                <p class="text-gray-800">{{ q.questionText|striptags|slice(0, 150) }}{% if q.questionText|striptags|length > 150 %}...{% endif %}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-red-600 font-bold">{{ q.failureRate|number_format(0) }}%</span>
                                <div class="text-xs text-gray-500">failure rate</div>
                                <div class="text-xs text-gray-400">({{ q.wrongCount }}/{{ q.totalAttempts }})</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg p-6 text-white">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-bolt mr-2"></i>
                Quick Actions
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <a href="{{ path('quiz_start_form') }}" 
                   class="flex items-center p-4 bg-white/10 rounded-lg hover:bg-white/20 transition">
                    <i class="fas fa-play text-2xl mr-3"></i>
                    <div>
                        <div class="font-semibold">Standard Quiz</div>
                        <div class="text-sm opacity-80">Free practice</div>
                    </div>
                </a>
                <a href="{{ path('quiz_start_form') }}?mode=certification" 
                   class="flex items-center p-4 bg-white/10 rounded-lg hover:bg-white/20 transition">
                    <i class="fas fa-certificate text-2xl mr-3"></i>
                    <div>
                        <div class="font-semibold">Mock Exam</div>
                        <div class="text-sm opacity-80">75 questions, 90 min</div>
                    </div>
                </a>
                <a href="{{ path('statistics_weak_areas') }}" 
                   class="flex items-center p-4 bg-white/10 rounded-lg hover:bg-white/20 transition">
                    <i class="fas fa-exclamation-circle text-2xl mr-3"></i>
                    <div>
                        <div class="font-semibold">Weak Areas</div>
                        <div class="text-sm opacity-80">Detailed analysis</div>
                    </div>
                </a>
                <a href="{{ path('statistics_dashboard') }}" 
                   class="flex items-center p-4 bg-white/10 rounded-lg hover:bg-white/20 transition">
                    <i class="fas fa-chart-line text-2xl mr-3"></i>
                    <div>
                        <div class="font-semibold">Statistics</div>
                        <div class="text-sm opacity-80">Overview</div>
                    </div>
                </a>
            </div>
        </div>

    </div>
</div>
{% endblock %}
