{% extends 'base.html.twig' %}

{% block title %}Revision Strategy - Symfony Certification{% endblock %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4 animate-fade-in-up">
        <div>
            <h1 class="text-2xl font-extrabold text-gray-800 flex items-center gap-2">
                <span class="w-10 h-10 bg-gradient-to-br from-primary-500 to-violet-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-primary-500/20">
                    <i class="fas fa-graduation-cap text-sm"></i>
                </span>
                Revision Strategy
            </h1>
            <p class="text-gray-400 text-sm mt-1">Personalized plan to pass the Symfony certification</p>
        </div>
        <a href="{{ path('quiz_start_form') }}" 
           class="bg-gradient-to-r from-primary-500 to-primary-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-primary-500/25 hover:-translate-y-0.5 transition-all flex items-center gap-2">
            <i class="fas fa-play"></i> Start a Quiz
        </a>
    </div>

    <!-- Readiness Score -->
    <div class="card-modern overflow-hidden mb-8 animate-fade-in-up stagger-1">
        <div class="bg-gradient-to-r from-primary-500 to-violet-500 px-5 py-3">
            <h2 class="text-sm font-bold text-white flex items-center gap-2">
                <i class="fas fa-tachometer-alt"></i> Readiness Score
            </h2>
        </div>
        <div class="p-5">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="text-center">
                    <div class="relative inline-flex">
                        <svg class="w-32 h-32">
                            <circle cx="64" cy="64" r="54" stroke="#f1f5f9" stroke-width="10" fill="none"/>
                            <circle cx="64" cy="64" r="54" 
                                    stroke="{% if strategy.readinessScore.status == 'ready' %}#10B981{% elseif strategy.readinessScore.status == 'almost-ready' %}#F59E0B{% elseif strategy.readinessScore.status == 'in-progress' %}#6366F1{% else %}#EF4444{% endif %}" 
                                    stroke-width="10" fill="none" stroke-linecap="round"
                                    stroke-dasharray="{{ strategy.readinessScore.score * 3.39 }} 339"
                                    transform="rotate(-90 64 64)"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-2xl font-black text-gray-800">{{ strategy.readinessScore.score|number_format(1) }}%</span>
                        </div>
                    </div>
                    <p class="mt-2 text-sm font-bold 
                        {% if strategy.readinessScore.status == 'ready' %}text-emerald-600
                        {% elseif strategy.readinessScore.status == 'almost-ready' %}text-amber-500
                        {% elseif strategy.readinessScore.status == 'in-progress' %}text-primary-500
                        {% else %}text-red-500{% endif %}">
                        {{ strategy.readinessScore.message }}
                    </p>
                </div>

                <div class="flex-1 grid grid-cols-3 gap-3">
                    <div class="text-center p-3 bg-blue-50 rounded-xl">
                        <div class="text-xl font-black text-blue-600">{{ strategy.readinessScore.coverageScore|number_format(1) }}%</div>
                        <div class="text-xs text-gray-500 font-medium">Coverage <span class="text-[10px] text-gray-400">(√ó20%)</span></div>
                    </div>
                    <div class="text-center p-3 bg-emerald-50 rounded-xl">
                        <div class="text-xl font-black text-emerald-600">{{ strategy.readinessScore.performanceScore|number_format(1) }}%</div>
                        <div class="text-xs text-gray-500 font-medium">Performance <span class="text-[10px] text-gray-400">(√ó60%)</span></div>
                    </div>
                    <div class="text-center p-3 bg-violet-50 rounded-xl">
                        <div class="text-xl font-black text-violet-600">{{ strategy.readinessScore.consistencyScore|number_format(1) }}%</div>
                        <div class="text-xs text-gray-500 font-medium">Consistency <span class="text-[10px] text-gray-400">(√ó20%)</span></div>
                    </div>
                </div>

                <div class="text-center p-5 bg-gray-50 rounded-xl">
                    <div class="text-3xl font-black {% if strategy.overallStats.bestCertScore >= 70 %}text-emerald-600{% else %}text-gray-600{% endif %}">
                        {{ strategy.overallStats.bestCertScore }}%
                    </div>
                    <div class="text-xs text-gray-500 font-medium mt-1">Best certif. score</div>
                    <div class="text-[10px] text-gray-400 mt-1">{{ strategy.overallStats.certificationAttempts }} simulation(s)</div>
                    <div class="mt-1 text-[10px] {% if strategy.overallStats.bestCertScore >= 70 %}text-emerald-500{% else %}text-amber-500{% endif %}">
                        Threshold: 70%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
        <div class="card-modern p-4 animate-fade-in-up stagger-2">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-primary-50 rounded-xl flex items-center justify-center"><i class="fas fa-question-circle text-primary-500 text-sm"></i></div>
                <div>
                    <div class="text-xl font-black text-gray-800">{{ strategy.practiceStats.questionsAttempted }}</div>
                    <div class="text-[10px] text-gray-400 font-medium">Answered</div>
                </div>
            </div>
        </div>
        <div class="card-modern p-4 animate-fade-in-up stagger-2">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-emerald-50 rounded-xl flex items-center justify-center"><i class="fas fa-eye text-emerald-500 text-sm"></i></div>
                <div>
                    <div class="text-xl font-black text-gray-800">{{ strategy.practiceStats.uniqueQuestionsAttempted }}</div>
                    <div class="text-[10px] text-gray-400 font-medium">Unique</div>
                </div>
            </div>
        </div>
        <div class="card-modern p-4 animate-fade-in-up stagger-3">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-amber-50 rounded-xl flex items-center justify-center"><i class="fas fa-database text-amber-500 text-sm"></i></div>
                <div>
                    <div class="text-xl font-black text-gray-800">{{ strategy.practiceStats.totalQuestionsInDb }}</div>
                    <div class="text-[10px] text-gray-400 font-medium">Available</div>
                </div>
            </div>
        </div>
        <div class="card-modern p-4 animate-fade-in-up stagger-3">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-violet-50 rounded-xl flex items-center justify-center"><i class="fas fa-percentage text-violet-500 text-sm"></i></div>
                <div>
                    <div class="text-xl font-black text-gray-800">{{ strategy.practiceStats.coveragePercentage }}%</div>
                    <div class="text-[10px] text-gray-400 font-medium">Coverage</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations + Daily Goals -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="card-modern overflow-hidden animate-fade-in-up stagger-3">
            <div class="bg-amber-50/80 px-5 py-3 border-b border-amber-100">
                <h2 class="text-sm font-bold text-amber-800 flex items-center gap-2">
                    <i class="fas fa-lightbulb"></i> Recommendations
                </h2>
            </div>
            <div class="p-5">
                {% if strategy.recommendations|length > 0 %}
                <div class="space-y-3">
                    {% for rec in strategy.recommendations %}
                    <div class="flex items-start p-3 rounded-xl text-sm
                        {% if rec.priority == 'high' %}bg-red-50/50 border-l-4 border-red-400
                        {% elseif rec.priority == 'medium' %}bg-amber-50/50 border-l-4 border-amber-400
                        {% else %}bg-emerald-50/50 border-l-4 border-emerald-400{% endif %}">
                        <div class="flex-shrink-0 mr-3 text-lg">
                            {% if rec.type == 'practice' %}üí™{% elseif rec.type == 'focus' %}üéØ{% elseif rec.type == 'exam' %}üìù{% elseif rec.type == 'study' %}üìñ{% elseif rec.type == 'success' %}üèÜ{% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 text-sm">{{ rec.title }}</h4>
                            <p class="text-xs text-gray-500 mt-0.5">{{ rec.description }}</p>
                            {% if rec.action %}
                                {% if rec.actionUrl %}
                                <a href="{{ rec.actionUrl }}" target="_blank" class="inline-flex items-center mt-1 text-xs font-bold text-primary-500 hover:text-primary-700 transition">
                                    {{ rec.action }} <i class="fas fa-external-link-alt ml-1 text-[10px]"></i>
                                </a>
                                {% elseif rec.actionRoute is defined and rec.actionRoute %}
                                <a href="{{ path(rec.actionRoute, rec.actionRouteParams|default({})) }}" 
                                   class="inline-flex items-center mt-1 text-xs font-bold text-primary-500 hover:text-primary-700 transition">
                                    {{ rec.action }} <i class="fas fa-arrow-right ml-1 text-[10px]"></i>
                                </a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-400 text-sm text-center py-4">Start practicing to receive recommendations.</p>
                {% endif %}
            </div>
        </div>

        <div class="card-modern overflow-hidden animate-fade-in-up stagger-4">
            <div class="bg-emerald-50/80 px-5 py-3 border-b border-emerald-100">
                <h2 class="text-sm font-bold text-emerald-800 flex items-center gap-2">
                    <i class="fas fa-bullseye"></i> Daily Goals
                </h2>
            </div>
            <div class="p-5">
                <div class="space-y-3">
                    {% for goal in strategy.dailyGoals %}
                    <div class="flex items-start p-3 bg-gray-50 rounded-xl">
                        <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-{{ goal.icon }} text-emerald-500 text-sm"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">{{ goal.title }}</h4>
                            <p class="text-primary-600 font-bold text-xs">{{ goal.target }}</p>
                            <p class="text-gray-400 text-[11px] mt-0.5">{{ goal.reason }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Analysis -->
    <div class="card-modern overflow-hidden mb-8 animate-fade-in-up">
        <div class="bg-primary-50/80 px-5 py-3 border-b border-primary-100">
            <h2 class="text-sm font-bold text-primary-800 flex items-center gap-2">
                <i class="fas fa-chart-pie"></i> Analysis by Certification Topic
            </h2>
            <p class="text-[11px] text-primary-500 mt-0.5">
                Based on the <a href="https://certification.symfony.com/exams/symfony.html" target="_blank" class="underline hover:text-primary-700">official topics</a> ‚Äî 75 questions, 14 sujets, 90 min
            </p>
        </div>
        <div class="p-5 space-y-3">
            {% for topic, data in strategy.topicAnalysis %}
            <div class="border rounded-xl p-4 transition
                {% if not data.inExam %}border-gray-200 bg-gray-50/50 opacity-60
                {% elseif data.status == 'weak' %}border-red-200 bg-red-50/30
                {% elseif data.status == 'moderate' %}border-amber-200 bg-amber-50/30
                {% elseif data.status == 'strong' %}border-emerald-200 bg-emerald-50/30
                {% else %}border-gray-200{% endif %}">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center flex-wrap gap-2">
                        <span class="font-bold text-gray-800 text-sm">{{ topic }}</span>
                        {% if data.inExam %}
                        <span class="px-2 py-0.5 text-[10px] rounded-lg bg-primary-100 text-primary-700 font-bold">{{ data.weight }}%</span>
                        {% else %}
                        <span class="px-2 py-0.5 text-[10px] rounded-lg bg-gray-200 text-gray-500"><i class="fas fa-ban mr-0.5"></i>Not in exam</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-bold {% if data.averageScore >= 80 %}text-emerald-600{% elseif data.averageScore >= 60 %}text-amber-500{% elseif data.averageScore > 0 %}text-red-500{% else %}text-gray-300{% endif %}">
                            {% if data.averageScore > 0 %}{{ data.averageScore }}%{% else %}-{% endif %}
                        </span>
                        <span class="px-2 py-0.5 text-[10px] rounded-lg font-bold
                            {% if data.status == 'strong' %}bg-emerald-100 text-emerald-700
                            {% elseif data.status == 'moderate' %}bg-amber-100 text-amber-700
                            {% elseif data.status == 'weak' %}bg-red-100 text-red-700
                            {% else %}bg-gray-100 text-gray-500{% endif %}">
                            {% if data.status == 'strong' %}Mastered{% elseif data.status == 'moderate' %}Needs review{% elseif data.status == 'weak' %}Needs work{% else %}Not started{% endif %}
                        </span>
                    </div>
                </div>
                <div class="mt-2">
                    <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                        <span>Coverage</span><span>{{ data.coverage }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="h-1.5 rounded-full {% if data.coverage >= 80 %}bg-emerald-500{% elseif data.coverage >= 50 %}bg-amber-500{% else %}bg-red-500{% endif %}" 
                             style="width: {{ data.coverage }}%"></div>
                    </div>
                </div>
                {% if data.subtopics|length > 0 %}
                <div class="mt-3 flex flex-wrap gap-1.5">
                    {% for subtopic in data.subtopics %}
                    <span class="inline-flex items-center px-2 py-0.5 text-[10px] rounded-lg
                        {% if subtopic.successRate >= 80 %}bg-emerald-100 text-emerald-700
                        {% elseif subtopic.successRate >= 60 %}bg-amber-100 text-amber-700
                        {% elseif subtopic.attempted > 0 %}bg-red-100 text-red-700
                        {% else %}bg-gray-100 text-gray-500{% endif %}"
                        title="{{ subtopic.name }}: {{ subtopic.uniqueSeen }}/{{ subtopic.available }} ({{ subtopic.coverage }}%){% if subtopic.attempted > 0 %}, {{ subtopic.successRate }}%{% endif %}">
                        {{ subtopic.name }}
                        {% if subtopic.attempted > 0 %}<span class="ml-0.5 font-bold">{{ subtopic.successRate }}%</span>{% endif %}
                        {% if subtopic.available > 0 %}<span class="ml-0.5 opacity-60">({{ subtopic.uniqueSeen }}/{{ subtopic.available }})</span>{% endif %}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Weekly Plan -->
    <div class="card-modern overflow-hidden mb-8 animate-fade-in-up">
        <div class="bg-violet-50/80 px-5 py-3 border-b border-violet-100">
            <h2 class="text-sm font-bold text-violet-800 flex items-center gap-2">
                <i class="fas fa-calendar-week"></i> Weekly Plan
            </h2>
        </div>
        <div class="p-5">
            <div class="grid grid-cols-2 md:grid-cols-7 gap-3">
                {% for day in strategy.weeklyPlan %}
                <div class="rounded-xl p-3 {% if loop.index == 6 %}bg-primary-50{% elseif loop.index == 7 %}bg-emerald-50{% else %}bg-gray-50{% endif %}">
                    <div class="font-bold text-gray-800 text-xs text-center mb-1">{{ day.day }}</div>
                    <div class="text-primary-600 font-bold text-[10px] text-center mb-2">{{ day.focus }}</div>
                    <div class="space-y-1.5">
                        {% for activity in day.activities %}
                        <div class="flex items-start text-[10px]">
                            {% if activity.type == 'study' %}<i class="fas fa-book text-blue-400 mr-1 mt-0.5"></i>
                            {% elseif activity.type == 'practice' %}<i class="fas fa-tasks text-emerald-400 mr-1 mt-0.5"></i>
                            {% elseif activity.type == 'review' %}<i class="fas fa-redo text-amber-400 mr-1 mt-0.5"></i>
                            {% elseif activity.type == 'exam' %}<i class="fas fa-file-alt text-violet-400 mr-1 mt-0.5"></i>
                            {% elseif activity.type == 'rest' %}<i class="fas fa-coffee text-gray-300 mr-1 mt-0.5"></i>{% endif %}
                            <div>
                                <span class="text-gray-600">{{ activity.description }}</span>
                                {% if activity.duration > 0 %}<span class="text-gray-300 block">({{ activity.duration }}min)</span>{% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Priority Areas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="card-modern overflow-hidden animate-fade-in-up">
            <div class="bg-red-50/80 px-5 py-3 border-b border-red-100">
                <h2 class="text-sm font-bold text-red-700 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i> Improvement Priorities
                </h2>
            </div>
            <div class="p-5">
                {% if strategy.priorityTopics.weakAreas|length > 0 %}
                <div class="space-y-2">
                    {% for area in strategy.priorityTopics.weakAreas|slice(0, 8) %}
                    <div class="flex items-center justify-between p-2.5 bg-red-50/50 rounded-lg">
                        <div class="flex-1 min-w-0">
                            <span class="text-gray-700 text-sm">{{ area.name }}</span>
                            {% if area.documentationUrl %}
                            <a href="{{ area.documentationUrl }}" target="_blank" class="text-[10px] text-primary-500 ml-1"><i class="fas fa-book"></i></a>
                            {% endif %}
                        </div>
                        <span class="text-red-500 font-bold text-sm ml-2">{{ area.averageScore|number_format(1) }}%</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-6"><div class="text-3xl mb-2">‚úÖ</div><p class="text-gray-400 text-sm">No weak areas detected!</p></div>
                {% endif %}
            </div>
        </div>

        <div class="card-modern overflow-hidden animate-fade-in-up">
            <div class="bg-blue-50/80 px-5 py-3 border-b border-blue-100">
                <h2 class="text-sm font-bold text-blue-700 flex items-center gap-2">
                    <i class="fas fa-compass"></i> Unexplored Topics
                </h2>
            </div>
            <div class="p-5">
                {% if strategy.priorityTopics.notAttemptedSubcategories|length > 0 %}
                <div class="flex flex-wrap gap-1.5">
                    {% for subcat in strategy.priorityTopics.notAttemptedSubcategories %}
                    <div class="inline-flex items-center px-2.5 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs">
                        <a href="{{ path('quiz_start_form') }}?subcategory={{ subcat.id }}" class="hover:text-blue-900 transition font-medium">
                            {{ subcat.category }} - {{ subcat.name }} <i class="fas fa-arrow-right ml-0.5 text-[10px]"></i>
                        </a>
                        {% if subcat.documentationUrl %}
                        <a href="{{ subcat.documentationUrl }}" target="_blank" class="ml-1 text-primary-500 hover:text-primary-700"><i class="fas fa-book text-[10px]"></i></a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-6"><div class="text-3xl mb-2">üèÜ</div><p class="text-gray-400 text-sm">All topics explored!</p></div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Most Failed -->
    {% if strategy.priorityTopics.mostFailedQuestions|length > 0 %}
    <div class="card-modern overflow-hidden mb-8 animate-fade-in-up">
        <div class="bg-amber-50/80 px-5 py-3 border-b border-amber-100">
            <h2 class="text-sm font-bold text-amber-800 flex items-center gap-2">
                <i class="fas fa-times-circle"></i> Most Failed Questions
            </h2>
        </div>
        <div class="p-5 space-y-2">
            {% for q in strategy.priorityTopics.mostFailedQuestions|slice(0, 5) %}
            <div class="p-3 border border-amber-200 rounded-xl flex items-start justify-between">
                <p class="text-gray-700 text-sm flex-1 pr-3">{{ q.questionText|striptags|slice(0, 150) }}{% if q.questionText|striptags|length > 150 %}...{% endif %}</p>
                <div class="text-right flex-shrink-0">
                    <span class="text-red-500 font-bold text-sm">{{ q.failureRate|number_format(0) }}%</span>
                    <div class="text-[10px] text-gray-400">({{ q.wrongCount }}/{{ q.totalAttempts }})</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="bg-gradient-to-r from-primary-500 to-violet-500 rounded-2xl p-6 text-white animate-fade-in-up">
        <h2 class="text-base font-bold mb-4 flex items-center gap-2">
            <i class="fas fa-bolt"></i> Quick Actions
        </h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <a href="{{ path('quiz_start_form') }}" class="flex items-center p-3 bg-white/10 rounded-xl hover:bg-white/20 transition group">
                <i class="fas fa-play text-xl mr-3 group-hover:scale-110 transition-transform"></i>
                <div><div class="font-bold text-sm">Standard Quiz</div><div class="text-[10px] opacity-70">Free practice</div></div>
            </a>
            <a href="{{ path('quiz_start_form') }}?mode=certification" class="flex items-center p-3 bg-white/10 rounded-xl hover:bg-white/20 transition group">
                <i class="fas fa-certificate text-xl mr-3 group-hover:scale-110 transition-transform"></i>
                <div><div class="font-bold text-sm">Mock Exam</div><div class="text-[10px] opacity-70">75Q, 90min</div></div>
            </a>
            <a href="{{ path('statistics_weak_areas') }}" class="flex items-center p-3 bg-white/10 rounded-xl hover:bg-white/20 transition group">
                <i class="fas fa-exclamation-circle text-xl mr-3 group-hover:scale-110 transition-transform"></i>
                <div><div class="font-bold text-sm">Weak Areas</div><div class="text-[10px] opacity-70">Analysis</div></div>
            </a>
            <a href="{{ path('statistics_dashboard') }}" class="flex items-center p-3 bg-white/10 rounded-xl hover:bg-white/20 transition group">
                <i class="fas fa-chart-line text-xl mr-3 group-hover:scale-110 transition-transform"></i>
                <div><div class="font-bold text-sm">Statistics</div><div class="text-[10px] opacity-70">Overview</div></div>
            </a>
        </div>
    </div>
</div>
{% endblock %}
