{% extends 'base.html.twig' %}

{% block title %}Question Detail - Statistics{% endblock %}

{% block body %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-6 animate-fade-in-up">
        <div class="flex items-center gap-3 mb-3">
            <a href="{{ backUrl|default(path('statistics_weak_areas')) }}" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition">
                <i class="fas fa-arrow-left text-sm"></i>
            </a>
            <h1 class="text-xl font-extrabold text-gray-800 flex items-center gap-2">
                <i class="fas fa-question-circle text-violet-500"></i> Question Detail
            </h1>
        </div>
        <div class="flex items-center text-xs text-gray-400 ml-11">
            <a href="{{ path('statistics_dashboard') }}" class="hover:text-primary-500 transition">Statistics</a>
            <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
            <a href="{{ path('statistics_weak_areas') }}" class="hover:text-primary-500 transition">Weak Areas</a>
            <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
            <span class="text-gray-600">Question #{{ question.id }}</span>
        </div>
    </div>

    <!-- Question Card -->
    <div class="card-modern overflow-hidden mb-6 animate-fade-in-up stagger-1">
        <div class="bg-gradient-to-r from-violet-500 to-primary-500 px-5 py-3">
            <div class="flex items-center gap-2 text-white">
                <span class="bg-white/20 px-3 py-1 rounded-lg text-xs font-bold">{{ question.category.name }}</span>
                <i class="fas fa-chevron-right text-[10px] opacity-60"></i>
                <span class="bg-white/20 px-3 py-1 rounded-lg text-xs font-bold">{{ question.subcategory.name }}</span>
            </div>
        </div>
        <div class="p-5">
            <div class="prose max-w-none question-text text-gray-800">{{ question.text|raw }}</div>
            <div class="flex flex-wrap gap-3 mt-5 pt-4 border-t border-gray-100">
                <span class="text-xs text-gray-400 flex items-center gap-1">
                    <i class="fas fa-layer-group text-violet-400"></i> Type: <strong class="text-gray-600">{{ question.type }}</strong>
                </span>
                <span class="text-xs text-gray-400 flex items-center gap-1">
                    <i class="fas fa-signal text-violet-400"></i>
                    {% for i in 1..3 %}
                        <i class="fas fa-star text-{{ i <= question.difficulty ? 'amber-400' : 'gray-200' }} text-[10px]"></i>
                    {% endfor %}
                </span>
                {% if question.isCertification %}
                <span class="text-xs text-emerald-600 font-bold flex items-center gap-1">
                    <i class="fas fa-certificate text-emerald-500"></i> Certification
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- AI Explanation -->
    <div class="card-modern overflow-hidden mb-6 animate-fade-in-up stagger-2">
        <div class="bg-gradient-to-r from-violet-500 to-purple-600 px-5 py-3 flex items-center justify-between">
            <h2 class="text-sm font-bold text-white flex items-center gap-2">
                <i class="fas fa-robot"></i> AI Explanation
            </h2>
            {% if aiExplanation %}
            <span class="text-xs text-white/70 bg-white/15 px-2 py-0.5 rounded-lg">
                <i class="fas fa-clock mr-0.5"></i> {{ aiExplanation.generatedAt|date('d/m/Y') }}
            </span>
            {% endif %}
        </div>

        <div class="border-b border-gray-100 bg-gray-50/50 px-5">
            <div class="flex items-center gap-1 -mb-px">
                {% for localeCode, localeName in supportedLocales %}
                    {% set isActive = selectedLocale == localeCode %}
                    {% set isAvailable = localeCode in availableLocales %}
                    <a href="{{ path('statistics_question_detail', {id: question.id, locale: localeCode, backUrl: backUrl}) }}"
                       class="inline-flex items-center gap-1.5 px-3 py-2.5 text-xs font-bold border-b-2 transition-colors
                              {{ isActive ? 'border-violet-500 text-violet-600 bg-white' : 'border-transparent text-gray-400 hover:text-gray-600 hover:border-gray-200' }}">
                        {{ localeName }}
                        {% if isAvailable %}
                        <span class="w-4 h-4 rounded-full bg-emerald-100 text-emerald-500 flex items-center justify-center"><i class="fas fa-check text-[8px]"></i></span>
                        {% else %}
                        <span class="w-4 h-4 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center"><i class="fas fa-minus text-[8px]"></i></span>
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
        </div>

        <div class="p-5">
            {% if aiExplanation %}
            <div class="prose prose-sm max-w-none ai-content">{{ aiExplanation.content|markdown }}</div>
            <div class="mt-5 pt-5 border-t border-gray-100 flex flex-wrap items-center gap-3">
                <span class="text-xs text-gray-400"><i class="fas fa-sync-alt mr-0.5"></i> Regenerate:</span>
                <form action="{{ path('statistics_generate_explanation', {id: question.id}) }}" method="POST" class="inline" onsubmit="showAILoader(event, '{{ selectedLocale }}')">
                    <input type="hidden" name="locale" value="{{ selectedLocale }}">
                    <input type="hidden" name="regenerate" value="1">
                    <input type="hidden" name="backUrl" value="{{ backUrl }}">
                    <button type="submit" class="px-3 py-1.5 text-xs bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition font-bold ai-regenerate-btn">
                        <i class="fas fa-redo mr-0.5"></i> {{ supportedLocales[selectedLocale] }}
                    </button>
                </form>
                {% for localeCode, localeName in supportedLocales %}
                    {% if localeCode not in availableLocales %}
                    <form action="{{ path('statistics_generate_explanation', {id: question.id}) }}" method="POST" class="inline" onsubmit="showAILoader(event, '{{ localeCode }}')">
                        <input type="hidden" name="locale" value="{{ localeCode }}">
                        <input type="hidden" name="backUrl" value="{{ backUrl }}">
                        <button type="submit" class="px-3 py-1.5 text-xs bg-violet-100 text-violet-700 rounded-lg hover:bg-violet-200 transition font-bold ai-generate-btn">
                            <i class="fas fa-magic mr-0.5"></i> {{ localeName }}
                        </button>
                    </form>
                    {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-10">
                <div class="text-5xl mb-4">ü§ñ</div>
                <h3 class="text-lg font-bold text-gray-700 mb-2">No explanation in {{ supportedLocales[selectedLocale] }}</h3>
                <p class="text-gray-400 text-sm mb-6 max-w-sm mx-auto">Generate an explanation based on the official Symfony documentation.</p>
                <div class="flex flex-wrap justify-center gap-3">
                    <form action="{{ path('statistics_generate_explanation', {id: question.id}) }}" method="POST" class="inline" onsubmit="showAILoader(event, '{{ selectedLocale }}')">
                        <input type="hidden" name="locale" value="{{ selectedLocale }}">
                        <input type="hidden" name="backUrl" value="{{ backUrl }}">
                        <button type="submit" class="bg-gradient-to-r from-violet-500 to-purple-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-violet-500/25 transition-all ai-generate-btn">
                            <i class="fas fa-magic mr-1"></i> Generate in {{ supportedLocales[selectedLocale] }}
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Answers -->
    <details class="card-modern overflow-hidden mb-6 animate-fade-in-up stagger-3">
        <summary class="bg-gray-50/80 px-5 py-3 border-b border-gray-100 cursor-pointer hover:bg-gray-100 transition">
            <h2 class="text-sm font-bold text-gray-800 inline flex items-center gap-2">
                <i class="fas fa-list-ul text-primary-500"></i> Answers ({{ question.answers|length }})
            </h2>
        </summary>
        <div class="p-5 space-y-2">
            {% for answer in question.answers %}
            <div class="flex items-start p-3 rounded-xl {{ answer.isCorrect ? 'bg-emerald-50 border border-emerald-200' : 'bg-gray-50 border border-gray-100' }}">
                <div class="flex-shrink-0 mr-3">
                    <i class="fas {{ answer.isCorrect ? 'fa-check-circle text-emerald-500' : 'fa-circle text-gray-300' }}"></i>
                </div>
                <div class="flex-grow question-text text-sm">{{ answer.text|raw }}</div>
            </div>
            {% endfor %}
        </div>
    </details>

    {% if question.explanation %}
    <details class="card-modern overflow-hidden mb-6 animate-fade-in-up stagger-4">
        <summary class="bg-amber-50/80 px-5 py-3 border-b border-amber-100 cursor-pointer hover:bg-amber-100 transition">
            <h2 class="text-sm font-bold text-amber-800 inline flex items-center gap-2">
                <i class="fas fa-lightbulb text-amber-500"></i> Original Explanation
            </h2>
        </summary>
        <div class="p-5">
            <div class="prose prose-sm max-w-none text-gray-700 question-text">{{ question.explanation|raw }}</div>
        </div>
    </details>
    {% endif %}

    {% if question.resourceUrl %}
    <div class="card-modern overflow-hidden mb-6 animate-fade-in-up stagger-4">
        <div class="bg-primary-50/80 px-5 py-3 border-b border-primary-100">
            <h2 class="text-sm font-bold text-primary-800 flex items-center gap-2">
                <i class="fas fa-book"></i> Documentation
            </h2>
        </div>
        <div class="p-5">
            <a href="{{ question.resourceUrl }}" target="_blank" rel="noopener noreferrer" 
               class="text-primary-500 hover:text-primary-700 text-sm transition">
                <i class="fas fa-external-link-alt mr-1"></i> {{ question.resourceUrl }}
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Performance -->
    <div class="card-modern overflow-hidden mb-6 animate-fade-in-up stagger-5">
        <div class="bg-amber-50/80 px-5 py-3 border-b border-amber-100">
            <h2 class="text-sm font-bold text-amber-800 flex items-center gap-2">
                <i class="fas fa-chart-bar"></i> Your Performance
            </h2>
        </div>
        <div class="p-5">
            {% if stats.totalAttempts > 0 %}
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <div class="text-center p-3 bg-gray-50 rounded-xl">
                    <div class="text-2xl font-black text-gray-800">{{ stats.totalAttempts }}</div>
                    <div class="text-xs text-gray-400">Attempts</div>
                </div>
                <div class="text-center p-3 bg-emerald-50 rounded-xl">
                    <div class="text-2xl font-black text-emerald-600">{{ stats.correctCount }}</div>
                    <div class="text-xs text-emerald-500">Correct</div>
                </div>
                <div class="text-center p-3 bg-red-50 rounded-xl">
                    <div class="text-2xl font-black text-red-500">{{ stats.wrongCount }}</div>
                    <div class="text-xs text-red-400">Incorrect</div>
                </div>
                <div class="text-center p-3 {{ stats.successRate >= 50 ? 'bg-emerald-50' : 'bg-red-50' }} rounded-xl">
                    <div class="text-2xl font-black {{ stats.successRate >= 50 ? 'text-emerald-600' : 'text-red-500' }}">{{ stats.successRate|number_format(0) }}%</div>
                    <div class="text-xs {{ stats.successRate >= 50 ? 'text-emerald-500' : 'text-red-400' }}">Rate</div>
                </div>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-2.5">
                <div class="h-2.5 rounded-full transition-all {{ stats.successRate >= 70 ? 'bg-emerald-500' : (stats.successRate >= 40 ? 'bg-amber-500' : 'bg-red-500') }}" 
                     style="width: {{ stats.successRate }}%"></div>
            </div>
            {% if stats.lastAttemptAt %}
            <div class="text-xs text-gray-400 mt-3">
                <i class="fas fa-clock mr-1"></i> Last attempt: {{ stats.lastAttemptAt|date('m/d/Y H:i') }}
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-6">
                <div class="text-4xl mb-2">‚ùì</div>
                <p class="text-gray-400 text-sm">Haven't answered this question yet.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Actions -->
    <div class="flex flex-wrap gap-3 justify-center animate-fade-in-up">
        <a href="{{ path('statistics_weak_areas') }}" 
           class="bg-gray-100 text-gray-600 px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-gray-200 transition flex items-center gap-2">
            <i class="fas fa-arrow-left"></i> Weak Areas
        </a>
        <a href="{{ path('quiz_by_subcategory', {id: question.subcategory.id}) }}" 
           class="bg-gradient-to-r from-violet-500 to-purple-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-violet-500/25 transition-all flex items-center gap-2">
            <i class="fas fa-play"></i> Practice {{ question.subcategory.name }}
        </a>
    </div>
</div>

<!-- AI Loading Modal -->
<div id="aiLoadingModal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full animate-fade-in-up">
        <div class="text-center mb-6">
            <div class="relative inline-block">
                <i class="fas fa-robot text-7xl text-violet-500 animate-bounce"></i>
            </div>
        </div>
        <h3 class="text-xl font-extrabold text-gray-800 text-center mb-1" id="aiLoadingTitle">AI Generation</h3>
        <p class="text-gray-400 text-sm text-center mb-6" id="aiLoadingSubtitle">Analyzing...</p>
        <div class="mb-5">
            <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span id="aiProgressStep">Connecting to API...</span>
                <span id="aiProgressPercent">0%</span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                <div id="aiProgressBar" class="h-2.5 bg-gradient-to-r from-violet-500 to-primary-500 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
        <div class="space-y-2">
            <div id="step1" class="flex items-center text-xs text-gray-400"><i class="fas fa-circle-notch fa-spin mr-2 text-violet-500"></i>Connecting to Claude API...</div>
            <div id="step2" class="flex items-center text-xs text-gray-300"><i class="fas fa-circle mr-2 text-gray-300"></i>Analyzing context...</div>
            <div id="step3" class="flex items-center text-xs text-gray-300"><i class="fas fa-circle mr-2 text-gray-300"></i>Searching documentation...</div>
            <div id="step4" class="flex items-center text-xs text-gray-300"><i class="fas fa-circle mr-2 text-gray-300"></i>Generating explanation...</div>
            <div id="step5" class="flex items-center text-xs text-gray-300"><i class="fas fa-circle mr-2 text-gray-300"></i>Finalizing...</div>
        </div>
        <div class="mt-5 text-center">
            <div class="text-xl font-black text-violet-600"><i class="fas fa-stopwatch mr-1"></i><span id="realTimer">0.0s</span></div>
            <div class="text-[10px] text-gray-300">Elapsed time</div>
        </div>
    </div>
</div>

<script>
let timerInterval = null, startTime = null;

function showAILoader(event, locale) {
    event.preventDefault();
    const form = event.target;
    const isRegenerate = form.querySelector('input[name="regenerate"]')?.value === '1';
    const modal = document.getElementById('aiLoadingModal');
    const progressBar = document.getElementById('aiProgressBar');
    const progressPercent = document.getElementById('aiProgressPercent');
    const progressStep = document.getElementById('aiProgressStep');
    const realTimer = document.getElementById('realTimer');

    document.getElementById('aiLoadingTitle').textContent = locale === 'fr' ? 'AI Generation' : 'AI Generation';
    document.getElementById('aiLoadingSubtitle').textContent = locale === 'fr' ? 'Analyzing...' : 'Analyzing...';
    modal.classList.remove('hidden');
    document.querySelectorAll('.ai-generate-btn, .ai-regenerate-btn').forEach(b => { b.disabled = true; b.classList.add('opacity-50'); });

    startTime = Date.now();
    realTimer.textContent = '0.0s';
    timerInterval = setInterval(() => { realTimer.textContent = ((Date.now() - startTime) / 1000).toFixed(1) + 's'; }, 100);

    const steps = [
        { id: 'step1', text: 'Connecting to API...', percent: 20, delay: 300 },
        { id: 'step2', text: 'Analyzing context...', percent: 40, delay: 1500 },
        { id: 'step3', text: 'Searching docs...', percent: 60, delay: 3000 },
        { id: 'step4', text: 'Generating...', percent: 80, delay: 5000 },
        { id: 'step5', text: 'Finalizing...', percent: 92, delay: 8000 }
    ];

    let current = 0, stepTimeout = null;
    function updateStep() {
        if (current < steps.length) {
            const s = steps[current];
            progressBar.style.width = s.percent + '%';
            progressPercent.textContent = s.percent + '%';
            progressStep.textContent = s.text;
            document.getElementById(s.id).querySelector('i').className = 'fas fa-circle-notch fa-spin mr-2 text-violet-500';
            document.getElementById(s.id).className = 'flex items-center text-xs text-gray-700 font-medium';
            if (current > 0) {
                const prev = document.getElementById(steps[current-1].id);
                prev.querySelector('i').className = 'fas fa-check-circle mr-2 text-emerald-500';
                prev.className = 'flex items-center text-xs text-emerald-600';
            }
            current++;
            if (current < steps.length) stepTimeout = setTimeout(updateStep, steps[current].delay - steps[current-1].delay);
        }
    }
    setTimeout(updateStep, steps[0].delay);

    fetch('{{ path('api_generate_explanation', {id: question.id}) }}', {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify({ locale, regenerate: isRegenerate })
    }).then(r => r.json()).then(data => {
        clearInterval(timerInterval); if (stepTimeout) clearTimeout(stepTimeout);
        progressBar.style.width = '100%'; progressPercent.textContent = '100%';
        steps.forEach(s => { const el = document.getElementById(s.id); el.querySelector('i').className = 'fas fa-check-circle mr-2 text-emerald-500'; el.className = 'flex items-center text-xs text-emerald-600'; });
        progressStep.textContent = 'Done!';
        realTimer.textContent = (data.duration || ((Date.now() - startTime) / 1000).toFixed(1)) + 's';
        if (data.success) { setTimeout(() => { const url = new URL(window.location.href); url.searchParams.set('locale', locale); window.location.href = url.toString(); }, 600); }
        else { alert('Erreur: ' + (data.error || 'An error occurred')); modal.classList.add('hidden'); document.querySelectorAll('.ai-generate-btn, .ai-regenerate-btn').forEach(b => { b.disabled = false; b.classList.remove('opacity-50'); }); }
    }).catch(error => {
        clearInterval(timerInterval); if (stepTimeout) clearTimeout(stepTimeout);
        alert('Erreur: ' + error.message); modal.classList.add('hidden');
        document.querySelectorAll('.ai-generate-btn, .ai-regenerate-btn').forEach(b => { b.disabled = false; b.classList.remove('opacity-50'); });
    });
}
</script>
{% endblock %}
