{% extends 'base.html.twig' %}

{% block title %}Progress Tracking - Symfony & PHP Quiz Trainer{% endblock %}

{% block body %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-chart-line text-indigo-600 mr-2"></i> Progress Tracking
        </h1>
        <p class="text-gray-500">View your score progression over time</p>
    </div>

    <!-- Main Progress Chart -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            Daily Average Scores (Last 30 Days)
        </h2>
        <div class="h-96">
            <canvas id="dailyProgressChart"></canvas>
        </div>
    </div>

    <!-- Individual Sessions Chart -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            Individual Session Scores
        </h2>
        <div class="h-80">
            <canvas id="sessionProgressChart"></canvas>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-center space-x-4">
        <a href="{{ path('quiz_start_form') }}" 
           class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition">
            <i class="fas fa-play mr-2"></i> Take a Quiz
        </a>
        <a href="{{ path('statistics_dashboard') }}" 
           class="bg-gray-100 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-200 transition">
            <i class="fas fa-chart-bar mr-2"></i> Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Daily Progress Chart
    try {
        const dailyData = await fetch('{{ path("api_progress_over_time") }}').then(r => r.json());
        new Chart(document.getElementById('dailyProgressChart'), {
            type: 'line',
            data: {
                labels: dailyData.labels,
                datasets: [{
                    label: 'Average Score',
                    data: dailyData.data,
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: value => value + '%'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: context => `Score: ${context.raw}%`
                        }
                    }
                }
            }
        });
    } catch (e) {
        console.log('No daily data available');
    }

    // Session Progress Chart
    try {
        const sessionData = await fetch('{{ path("api_score_progression") }}').then(r => r.json());
        
        const colors = sessionData.categories.map(cat => {
            if (cat === 'Symfony') return '#1a1a1a';
            if (cat === 'PHP') return '#777BB4';
            return '#4F46E5';
        });

        new Chart(document.getElementById('sessionProgressChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Session Scores',
                    data: sessionData.labels.map((label, i) => ({
                        x: i,
                        y: sessionData.data[i],
                        label: sessionData.categories[i]
                    })),
                    backgroundColor: colors,
                    pointRadius: 8,
                    pointHoverRadius: 10,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: value => value + '%'
                        }
                    },
                    x: {
                        display: false
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: context => {
                                const point = context.raw;
                                return `${point.label}: ${point.y}%`;
                            }
                        }
                    }
                }
            }
        });
    } catch (e) {
        console.log('No session data available');
    }
});
</script>
{% endblock %}
